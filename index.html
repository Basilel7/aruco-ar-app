<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArUco AR App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }
        
        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .controls button {
            padding: 12px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .controls button:hover {
            background: #0056b3;
        }
        
        .controls button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #imageInput {
            display: none;
        }
        
        .debug-info {
            position: absolute;
            top: 120px;
            right: 20px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        .status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .marker-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            max-width: 200px;
        }
        
        .marker-info h3 {
            margin-bottom: 10px;
            color: #4CAF50;
        }
        
        .overlay-image {
            position: absolute;
            pointer-events: none;
            border: 2px solid #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        
        <div class="controls">
            <button id="startBtn">Start Camera</button>
            <button id="switchBtn" disabled>Switch Camera</button>
            <button id="selectImageBtn">Select Overlay Image</button>
            <input type="file" id="imageInput" accept="image/*" capture="user">
            <button id="debugBtn">Show Debug Info</button>
        </div>
        
        <div class="status" id="status">Click "Start Camera" to begin</div>
        
        <div class="debug-info" id="debugInfo" style="display: none;">
            <h4>Debug Info</h4>
            <div id="debugContent"></div>
        </div>
        
        <div class="marker-info" id="markerInfo" style="display: none;">
            <h3>Detected Markers</h3>
            <div id="markerList"></div>
        </div>
    </div>

    <!-- ArUco Library -->
    <script src="https://damianofalcioni.github.io/js-aruco2/js/aruco.js"></script>
    <script src="https://damianofalcioni.github.io/js-aruco2/js/cv.js"></script>

    <script>
        class ArUcoApp {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.detector = new AR.Detector();
                this.isRunning = false;
                this.currentStream = null;
                this.facingMode = 'environment'; // back camera
                this.overlayImage = null;
                this.detectedMarkers = [];
                
                this.initializeElements();
                this.setupEventListeners();
                this.resizeCanvas();
            }
            
            initializeElements() {
                this.startBtn = document.getElementById('startBtn');
                this.switchBtn = document.getElementById('switchBtn');
                this.selectImageBtn = document.getElementById('selectImageBtn');
                this.imageInput = document.getElementById('imageInput');
                this.status = document.getElementById('status');
                this.markerInfo = document.getElementById('markerInfo');
                this.markerList = document.getElementById('markerList');
                this.debugBtn = document.getElementById('debugBtn');
                this.debugInfo = document.getElementById('debugInfo');
                this.debugContent = document.getElementById('debugContent');
            }
            
            setupEventListeners() {
                this.startBtn.addEventListener('click', () => this.toggleCamera());
                this.switchBtn.addEventListener('click', () => this.switchCamera());
                this.selectImageBtn.addEventListener('click', () => this.imageInput.click());
                this.imageInput.addEventListener('change', (e) => this.handleImageSelect(e));
                this.debugBtn.addEventListener('click', () => this.toggleDebugInfo());
                window.addEventListener('resize', () => this.resizeCanvas());
            }
            
            resizeCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }
            
            async toggleCamera() {
                if (!this.isRunning) {
                    await this.startCamera();
                } else {
                    this.stopCamera();
                }
            }
            
            async startCamera() {
                try {
                    this.updateStatus('Starting camera...');
                    this.updateDebugInfo('Checking camera support...');
                    
                    // Check if getUserMedia is supported
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('getUserMedia not supported');
                    }
                    
                    // Check if we're on HTTPS or localhost
                    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                    this.updateDebugInfo(`Protocol: ${location.protocol}, Secure: ${isSecure}`);
                    
                    if (!isSecure) {
                        throw new Error('Camera requires HTTPS or localhost');
                    }
                    
                    const constraints = {
                        video: {
                            facingMode: this.facingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    
                    this.updateDebugInfo('Requesting camera permission...');
                    this.currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.currentStream;
                    
                    await new Promise((resolve) => {
                        this.video.onloadedmetadata = resolve;
                    });
                    
                    this.isRunning = true;
                    this.startBtn.textContent = 'Stop Camera';
                    this.switchBtn.disabled = false;
                    this.updateStatus('Camera active - Point at ArUco markers');
                    this.updateDebugInfo('Camera started successfully');
                    
                    this.startDetection();
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    this.updateStatus(`Error: ${error.message}`);
                    this.updateDebugInfo(`Camera error: ${error.message}`);
                }
            }
            
            stopCamera() {
                if (this.currentStream) {
                    this.currentStream.getTracks().forEach(track => track.stop());
                }
                
                this.isRunning = false;
                this.startBtn.textContent = 'Start Camera';
                this.switchBtn.disabled = true;
                this.updateStatus('Camera stopped');
                this.markerInfo.style.display = 'none';
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }
            
            async switchCamera() {
                this.facingMode = this.facingMode === 'environment' ? 'user' : 'environment';
                
                if (this.isRunning) {
                    this.stopCamera();
                    await new Promise(resolve => setTimeout(resolve, 100));
                    await this.startCamera();
                }
            }
            
            startDetection() {
                const detect = () => {
                    if (!this.isRunning) return;
                    
                    if (this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
                        this.detectMarkers();
                    }
                    
                    requestAnimationFrame(detect);
                };
                
                detect();
            }
            
            detectMarkers() {
                // Create temporary canvas for detection
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCanvas.width = this.video.videoWidth;
                tempCanvas.height = this.video.videoHeight;
                
                tempCtx.drawImage(this.video, 0, 0);
                
                // Get image data for ArUco detection
                const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                
                // Detect markers
                const markers = this.detector.detect(imageData);
                this.detectedMarkers = markers;
                
                // Clear canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Calculate scaling factors
                const scaleX = this.canvas.width / tempCanvas.width;
                const scaleY = this.canvas.height / tempCanvas.height;
                
                if (markers.length > 0) {
                    this.drawMarkers(markers, scaleX, scaleY);
                    this.updateMarkerInfo(markers);
                    this.markerInfo.style.display = 'block';
                } else {
                    this.markerInfo.style.display = 'none';
                }
            }
            
            drawMarkers(markers, scaleX, scaleY) {
                markers.forEach((marker) => {
                    // Scale corner coordinates
                    const corners = marker.corners.map(corner => ({
                        x: corner.x * scaleX,
                        y: corner.y * scaleY
                    }));
                    
                    // Draw marker border
                    this.ctx.strokeStyle = '#00ff00';
                    this.ctx.lineWidth = 3;
                    this.ctx.beginPath();
                    corners.forEach((corner, index) => {
                        if (index === 0) {
                            this.ctx.moveTo(corner.x, corner.y);
                        } else {
                            this.ctx.lineTo(corner.x, corner.y);
                        }
                    });
                    this.ctx.closePath();
                    this.ctx.stroke();
                    
                    // Draw marker ID
                    const center = this.getMarkerCenter(corners);
                    this.ctx.fillStyle = '#00ff00';
                    this.ctx.font = 'bold 20px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(`ID: ${marker.id}`, center.x, center.y);
                    
                    // Draw overlay image if available
                    if (this.overlayImage) {
                        this.drawImageOverlay(corners);
                    }
                });
            }
            
            getMarkerCenter(corners) {
                const centerX = corners.reduce((sum, corner) => sum + corner.x, 0) / corners.length;
                const centerY = corners.reduce((sum, corner) => sum + corner.y, 0) / corners.length;
                return { x: centerX, y: centerY };
            }
            
            drawImageOverlay(corners) {
                if (!this.overlayImage) return;
                
                // Save context state
                this.ctx.save();
                
                // Calculate transformation matrix for homography
                const srcCorners = [
                    { x: 0, y: 0 },
                    { x: this.overlayImage.width, y: 0 },
                    { x: this.overlayImage.width, y: this.overlayImage.height },
                    { x: 0, y: this.overlayImage.height }
                ];
                
                // Simple perspective transformation approximation
                const topLeft = corners[0];
                const topRight = corners[1];
                const bottomRight = corners[2];
                const bottomLeft = corners[3];
                
                // Calculate transformation
                const width = Math.sqrt(Math.pow(topRight.x - topLeft.x, 2) + Math.pow(topRight.y - topLeft.y, 2));
                const height = Math.sqrt(Math.pow(bottomLeft.x - topLeft.x, 2) + Math.pow(bottomLeft.y - topLeft.y, 2));
                
                // Simple approach: use transform to position and scale the image
                this.ctx.globalAlpha = 0.8;
                
                // Create clipping path
                this.ctx.beginPath();
                this.ctx.moveTo(corners[0].x, corners[0].y);
                this.ctx.lineTo(corners[1].x, corners[1].y);
                this.ctx.lineTo(corners[2].x, corners[2].y);
                this.ctx.lineTo(corners[3].x, corners[3].y);
                this.ctx.closePath();
                this.ctx.clip();
                
                // Draw image with basic transformation
                const scaleX = width / this.overlayImage.width;
                const scaleY = height / this.overlayImage.height;
                
                this.ctx.drawImage(
                    this.overlayImage,
                    topLeft.x,
                    topLeft.y,
                    this.overlayImage.width * scaleX,
                    this.overlayImage.height * scaleY
                );
                
                // Restore context state
                this.ctx.restore();
            }
            
            updateMarkerInfo(markers) {
                this.markerList.innerHTML = '';
                markers.forEach(marker => {
                    const markerDiv = document.createElement('div');
                    markerDiv.innerHTML = `
                        <strong>ID ${marker.id}</strong><br>
                        Corners: ${marker.corners.length}<br>
                        <hr style="margin: 5px 0;">
                    `;
                    this.markerList.appendChild(markerDiv);
                });
            }
            
            handleImageSelect(event) {
                const file = event.target.files[0];
                this.updateDebugInfo(`File selected: ${file ? file.name : 'none'}`);
                
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            this.overlayImage = img;
                            this.updateStatus(`Overlay image loaded: ${img.width}x${img.height}`);
                            this.updateDebugInfo(`Image loaded: ${img.width}x${img.height}px`);
                        };
                        img.onerror = () => {
                            this.updateDebugInfo('Failed to load image');
                        };
                        img.src = e.target.result;
                    };
                    reader.onerror = () => {
                        this.updateDebugInfo('Failed to read file');
                    };
                    reader.readAsDataURL(file);
                } else {
                    this.updateDebugInfo('Invalid file type or no file selected');
                }
            }
            
            toggleDebugInfo() {
                const isVisible = this.debugInfo.style.display !== 'none';
                this.debugInfo.style.display = isVisible ? 'none' : 'block';
                this.debugBtn.textContent = isVisible ? 'Show Debug Info' : 'Hide Debug Info';
                
                if (!isVisible) {
                    this.updateDebugInfo('Debug info enabled');
                }
            }
            
            updateDebugInfo(message) {
                const timestamp = new Date().toLocaleTimeString();
                const currentContent = this.debugContent.innerHTML;
                this.debugContent.innerHTML = `${currentContent}<br>[${timestamp}] ${message}`;
                this.debugContent.scrollTop = this.debugContent.scrollHeight;
            }
            
            updateStatus(message) {
                this.status.textContent = message;
                console.log('Status:', message);
            }
        }
        
        // Initialize app when page loads
        window.addEventListener('load', () => {
            new ArUcoApp();
        });
    </script>
</body>
</html>